name: Gemini PR Summary for Logbook

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary via Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Diff holen
          PR_DIFF=$(git diff origin/main...HEAD)
          
          # 2. Payload sicher bauen
          jq -n \
            --arg text "Du bist Techa. Analysiere diesen Diff für das Logbuch. Halte dich an das Sorority Protocol v2.1 Format:\n\n$PR_DIFF" \
            '{contents: [{parts: [{text: $text}]}]}' > payload.json

          # 3. API Call an Gemini 1.5 Flash (Stabilerer Alias)
          # Wir nutzen hier 'gemini-1.5-flash', da dieser Endpoint zuverlässiger antwortet.
          curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -X POST \
            -d @payload.json > response.json
            
          # 4. Antwort extrahieren
          # Falls Fehler auftreten, geben wir sie zur Diagnose aus
          if ! jq -e '.candidates[0].content.parts[0].text' response.json > /dev/null; then
            echo "::error::API Response invalid. Content:"
            cat response.json
            exit 1
          fi

          SUMMARY=$(jq -r '.candidates[0].content.parts[0].text' response.json)
          
          # 5. Output sicher speichern
          echo "SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = process.env.SUMMARY;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            })
