name: Gemini PR Summary for Logbook

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

- name: Gemini AI Audit
        id: gemini
        uses: google-github-actions/auth@v2
        with:
          api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate Summary via API
        run: |
          # Wir nutzen einen direkten API-Aufruf, um die 'Repository not found' Fehler zu umgehen.
          # Das ist effizienter und weniger fehleranfällig für unsere Infrastruktur.
          PR_DIFF=$(git diff origin/main...HEAD)
          
          curl https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
            -H 'Content-Type: application/json' \
            -X POST \
            -d '{
              "contents": [{
                "parts":[{"text": "Du bist Techa. Analysiere diesen Diff für das Logbuch: '"$PR_DIFF"'"}]
              }]
            }' > summary_output.json
