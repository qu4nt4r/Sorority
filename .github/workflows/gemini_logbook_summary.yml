name: Gemini PR Summary for Logbook

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary via Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. RADAR: Welche Modelle sieht dein Key?
          echo "ðŸ“¡ Frage verfÃ¼gbare Modelle ab..."
          curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=$GEMINI_API_KEY" > models.json
          
          echo "ðŸ“‹ VerfÃ¼gbare Modelle (Auszug):"
          # Wir filtern die JSON-Antwort, um nur die Namen zu sehen.
          jq -r '.models[]?.name' models.json || cat models.json
          echo "----------------------------------------"

          # 2. Diff holen
          PR_DIFF=$(git diff origin/main...HEAD)
          
          # 3. Payload bauen
          jq -n \
            --arg text "Du bist Techa. Analysiere diesen Diff fÃ¼r das Logbuch. Halte dich an das Sorority Protocol v2.1 Format:\n\n$PR_DIFF" \
            '{contents: [{parts: [{text: $text}]}]}' > payload.json

          # 4. API Call - Versuch mit 'gemini-1.5-flash-latest'
          # Falls das auch fehlschlÃ¤gt, haben wir oben im Log die Liste der GÃœLTIGEN Namen.
          curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -X POST \
            -d @payload.json > response.json
            
          # 5. Antwort validieren
          # Wir prÃ¼fen explizit auf Fehler und geben sie aus
          if ! jq -e '.candidates[0].content.parts[0].text' response.json > /dev/null; then
            echo "::error::API Response invalid. Full Response:"
            cat response.json
            exit 1
          fi

          SUMMARY=$(jq -r '.candidates[0].content.parts[0].text' response.json)
          
          # Output speichern
          echo "SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = process.env.SUMMARY;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            })
