name: Gemini PR Summary for Logbook

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch: # Ermöglicht manuelles Starten zum Testen!

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Secret Presence (Debug)
        env:
          THE_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$THE_KEY" ]; then
            echo "::error::⛔ SECRET IST LEER! Prüfe GitHub Settings -> Secrets -> Actions."
            exit 1
          else
            echo "✅ Secret wurde erfolgreich in die Env geladen (Länge: ${#THE_KEY} Zeichen)."
          fi

      - name: Generate Summary via Gemini API
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PR_DIFF=$(git diff origin/main...HEAD)
          
          # Payload bauen
          jq -n \
            --arg text "Du bist Techa. Fasse diesen Code-Diff kurz zusammen:\n\n$PR_DIFF" \
            '{contents: [{parts: [{text: $text}]}]}' > payload.json

          # API Call mit -v (verbose) für mehr Details im Fehlerfall
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d @payload.json)
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
             echo "::error::API Request failed with status $HTTP_CODE"
             cat response.json
             exit 1
          fi
            
          SUMMARY=$(jq -r '.candidates[0].content.parts[0].text' response.json)
          
          echo "SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment to PR
        if: github.event_name == 'pull_request' # Nur bei echtem PR ausführen
        uses: actions/github-script@v7
        with:
          script: |
            const summary = process.env.SUMMARY;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            })
